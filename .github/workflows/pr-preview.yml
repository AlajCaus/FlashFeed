name: PR Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'lib/**'
      - 'web/**'
      - 'pubspec.yaml'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: write
  deployments: write

jobs:
  preview:
    name: Deploy PR Preview
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v5

    - name: 🎯 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.3'
        channel: 'stable'
        cache: true

    - name: 📦 Install Dependencies
      run: flutter pub get

    - name: 🧪 Run Tests
      run: flutter test --reporter=compact
      continue-on-error: true

    - name: 🏗️ Build Preview
      run: |
        flutter config --enable-web
        flutter build web --release \
          --base-href "/pr-preview-${{ github.event.pull_request.number }}/" \
          --dart-define=BUILD_ENV=preview \
          --dart-define=PR_NUMBER=${{ github.event.pull_request.number }}

    - name: 📤 Deploy to Preview
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./build/web
        destination_dir: pr-preview-${{ github.event.pull_request.number }}
        keep_files: false

    - name: 💬 Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const previewUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/pr-preview-${prNumber}/`;

          const comment = `## 🚀 Preview Deployment Ready!

          Your PR has been deployed to: ${previewUrl}

          ### Deployment Details:
          - **Environment:** Preview
          - **PR:** #${prNumber}
          - **Commit:** ${context.sha.substring(0, 7)}
          - **Timestamp:** ${new Date().toISOString()}

          ### Quick Links:
          - [🏠 Home](${previewUrl})
          - [🛍️ Offers](${previewUrl}#/offers)
          - [⚡ Flash Deals](${previewUrl}#/flash-deals)
          - [🗺️ Map](${previewUrl}#/map)

          ---
          This preview will be automatically updated with new commits.`;

          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: comment
          });

  cleanup:
    name: Cleanup Old Previews
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'

    steps:
    - name: 🧹 Remove Preview
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./empty
        destination_dir: pr-preview-${{ github.event.pull_request.number }}
        keep_files: false

    - name: 💬 Comment Cleanup
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
            body: '🧹 Preview deployment has been removed.'
          });